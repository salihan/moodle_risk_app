{% extends "base.html" %}

{% block title %}Student Risk Dashboard{% endblock %}

{% block content %}
<div class="">
  <div class="page-title">
    <div class="title_left">
      <h3>Student Risk Dashboard</h3>
    </div>
  </div>
  <div class="clearfix"></div>

  <!-- Tiles -->
  <div class="row top_tiles" style="margin: 10px 0;">
    <div class="col-md-3 col-sm-3 col-xs-6 tile">
      <span>Total Students</span>
      <h2>{{ students|length }}</h2>
    </div>
    <div class="col-md-3 col-sm-3 col-xs-6 tile">
      <span>High Risk</span>
      <h2>{{ students | selectattr('risk_label', 'equalto', 'high') | list | length }}</h2>
    </div>
    <div class="col-md-3 col-sm-3 col-xs-6 tile">
      <span>Medium Risk</span>
      <h2>{{ students | selectattr('risk_label', 'equalto', 'medium') | list | length }}</h2>
    </div>
    <div class="col-md-3 col-sm-3 col-xs-6 tile">
      <span>Low Risk</span>
      <h2>{{ students | selectattr('risk_label', 'equalto', 'low') | list | length }}</h2>
    </div>
  </div>

  <!-- Charts row -->
  <div class="row">
    <!-- Risk distribution donut -->
    <div class="col-md-6 col-sm-6 col-xs-12">
      <div class="x_panel">
        <div class="x_title">
          <h2>Risk Distribution</h2>
          <div class="clearfix"></div>
        </div>
        <div class="x_content">
          <canvas id="riskDonutChart" style="width: 100%; height: 260px;"></canvas>
        </div>
      </div>
    </div>

    <!-- Risk score per student (bar) -->
    <div class="col-md-6 col-sm-6 col-xs-12">
      <div class="x_panel">
        <div class="x_title">
          <h2>Risk Score by Student</h2>
          <div class="clearfix"></div>
        </div>
        <div class="x_content">
          <canvas id="riskBarChart" style="width: 100%; height: 260px;"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Table of students -->
  <div class="row">
    <div class="col-md-12 col-sm-12 col-xs-12">
      <div class="x_panel">
        <div class="x_title">
          <h2>Students at Risk</h2>
          <div class="clearfix"></div>
        </div>
        <div class="x_content">
          <div class="table-responsive">
            <table class="table table-striped jambo_table">
              <thead>
                <tr class="headings">
                  <th class="column-title">Name</th>
                  <th class="column-title">Risk</th>
                  <th class="column-title">Score</th>
                  <th class="column-title">Avg Grade</th>
                  <th class="column-title">Last Access</th>
                  <th class="column-title no-link last"><span class="nobr">Details</span></th>
                </tr>
              </thead>
              <tbody>
                {% for s in students %}
                <tr class="even pointer">
                  <td>{{ s.name }}</td>
                  <td>
                    {% if s.risk_label == 'high' %}
                      <span class="label label-danger">High</span>
                    {% elif s.risk_label == 'medium' %}
                      <span class="label label-warning">Medium</span>
                    {% else %}
                      <span class="label label-success">Low</span>
                    {% endif %}
                  </td>
                  <td>{{ "%.2f"|format(s.risk_score) }}</td>
                  <td>{{ "%.2f"|format(s.avg_grade or 0) }}</td>
                  <td>{{ s.lastaccess }}</td>
                  <td class="last">
                    <a href="{{ url_for('dashboard.student_detail', user_id=s.user_id) }}"
                       class="btn btn-xs btn-primary">View</a>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
  // Counts per risk level using Jinja
  var highCount = {{ students | selectattr('risk_label', 'equalto', 'high') | list | length }};
  var mediumCount = {{ students | selectattr('risk_label', 'equalto', 'medium') | list | length }};
  var lowCount = {{ students | selectattr('risk_label', 'equalto', 'low') | list | length }};

  // Data for "Risk Score by Student" bar chart
  var studentNames = {{ students | map(attribute='name') | list | tojson }};
  var studentRiskScores = {{ students | map(attribute='risk_score') | list | tojson }};

  // Risk distribution donut chart
  var ctxDonut = document.getElementById('riskDonutChart');
  if (ctxDonut && window.Chart) {
    new Chart(ctxDonut, {
      type: 'doughnut',
      data: {
        labels: ['High', 'Medium', 'Low'],
        datasets: [{
          data: [highCount, mediumCount, lowCount],
          backgroundColor: ['#E74C3C', '#F1C40F', '#2ECC71'],
          hoverBackgroundColor: ['#C0392B', '#F39C12', '#27AE60']
        }]
      },
      options: {
        legend: {
          position: 'bottom'
        },
        cutoutPercentage: 60,
        responsive: true,
        maintainAspectRatio: false
      }
    });
  }

  // Risk score per student bar chart
  var ctxBar = document.getElementById('riskBarChart');
  if (ctxBar && window.Chart) {
    new Chart(ctxBar, {
      type: 'bar',
      data: {
        labels: studentNames,
        datasets: [{
          label: 'Risk score',
          data: studentRiskScores,
          backgroundColor: '#3498DB'
        }]
      },
      options: {
        scales: {
          yAxes: [{
            ticks: {
              beginAtZero: true,
              max: 1
            }
          }],
          xAxes: [{
            ticks: {
              autoSkip: true,
              maxTicksLimit: 10
            }
          }]
        },
        legend: {
          display: false
        },
        responsive: true,
        maintainAspectRatio: false
      }
    });
  }
</script>
{% endblock %}

